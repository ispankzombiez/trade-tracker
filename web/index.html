<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #00cc66;
            --secondary-color: #00aa55;
            --accent-color: #ffa500;
            --danger-color: #ff6b6b;
            --dark-bg: #1a1a1a;
            --darker-bg: #0d1117;
            --card-bg: #21262d;
            --text-light: #ffffff;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --success-color: #00aa55;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--darker-bg);
            min-height: 100vh;
            color: var(--text-light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-areas: 
                "title title title"
                "farm-link controls refresh";
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }

        .header h1 {
            grid-area: title;
            color: var(--primary-color);
            font-size: 2.5rem;
            margin: 0 0 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            justify-self: center;
        }

        .farm-link {
            grid-area: farm-link;
            justify-self: start;
            display: inline-block;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 1rem;
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            border-radius: 25px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .farm-link:hover {
            background: var(--primary-color);
            color: var(--dark-bg);
            transform: scale(1.05);
        }

        .header-controls {
            grid-area: controls;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            justify-self: center;
        }

        .last-updated {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85rem;
            margin: 0;
            white-space: nowrap;
        }

        .debug-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0.8;
            margin: 0;
        }

        .debug-toggle input[type="checkbox"] {
            accent-color: var(--primary-color);
            scale: 1.1;
        }

        .refresh-btn {
            grid-area: refresh;
            justify-self: end;
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1rem;
            white-space: nowrap;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Mobile responsive design */
        @media (max-width: 768px) {
            .header {
                grid-template-areas: 
                    "title"
                    "farm-link"
                    "controls"
                    "refresh";
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2rem;
                margin-bottom: 10px;
            }
            
            .farm-link,
            .refresh-btn {
                justify-self: center;
                width: fit-content;
            }
            
            .header-controls {
                justify-self: center;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .farm-link,
            .refresh-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .last-updated {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .debug-toggle {
                font-size: 0.85rem;
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .user-selector {
            margin-bottom: 20px;
        }

        .timeframe-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .timeframe-btn {
            background: var(--card-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .timeframe-btn:hover {
            background: var(--primary-color);
            color: var(--dark-bg);
        }

        .timeframe-btn.active {
            background: var(--primary-color);
            color: var(--dark-bg);
        }

        .user-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-btn {
            background: var(--card-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .user-btn:hover {
            background: var(--primary-color);
            color: var(--darker-bg);
            transform: scale(1.05);
        }

        .user-btn.active {
            background: var(--primary-color);
            color: var(--darker-bg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .profit-positive {
            background: linear-gradient(135deg, var(--success-color), #2ecc71) !important;
        }

        .profit-negative {
            background: linear-gradient(135deg, var(--danger-color), #c0392b) !important;
        }

        .recent-activity {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(0, 204, 102, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .detailed-trades {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .trade-column {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .trade-column h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .trade-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .trade-item {
            background: var(--darker-bg);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            color: var(--text-light);
        }

        .trade-item.buy {
            border-left-color: var(--danger-color);
        }

        .trade-item.sell {
            border-left-color: var(--success-color);
        }

        .trade-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            color: var(--text-light);
        }

        .trade-item-details {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .trade-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text-light);
        }

        .trade-buy {
            background: var(--danger-color);
        }

        .trade-sell {
            background: var(--success-color);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .error {
            background: var(--danger-color);
            color: var(--text-light);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .top-traders-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .trader-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .trader-item:hover {
            background: rgba(46, 204, 113, 0.1);
            transform: translateX(5px);
        }

        .trader-rank {
            background: var(--accent-color);
            color: var(--text-light);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .trader-info {
            flex: 1;
            margin-left: 15px;
        }

        .trader-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .trader-stats {
            font-size: 0.9rem;
            color: #666;
        }

        .profit-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .user-buttons {
                justify-content: center;
            }
        }

        .refresh-btn {
            background: var(--primary-color);
            color: var(--darker-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        .tab-container {
            background: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
        }

        .user-selector label {
            color: var(--text-light);
            font-weight: bold;
            white-space: nowrap;
        }

        #userDropdown {
            background: var(--darker-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 1rem;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #userDropdown:hover {
            border-color: var(--primary-color);
        }

        #userDropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 204, 102, 0.2);
        }

        #userDropdown option {
            background: var(--darker-bg);
            color: var(--text-light);
            padding: 8px;
        }

        #activeUserTab {
            display: flex;
            align-items: center;
        }

        .tab-btn {
            background: var(--darker-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 1rem;
        }

        .tab-btn:hover {
            background: var(--primary-color);
            color: var(--darker-bg);
            transform: scale(1.05);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: var(--darker-bg);
        }

        .general-stats {
            display: block;
        }

        .general-stats.hidden {
            display: none;
        }

        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }

        .debug-panel.visible {
            display: block;
        }

        /* Inventory Chart Styles */
        .inventory-chart-container {
            position: relative;
        }
        
        .inventory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .inventory-controls {
            display: flex;
            gap: 10px;
        }
        
        .toggle-btn, .fullscreen-btn {
            background: var(--primary-color);
            color: var(--dark-bg);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .toggle-btn:hover, .fullscreen-btn:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }
        
        .category-filters {
            margin: 15px 0;
            padding: 15px;
            background: var(--dark-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .filter-header {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        
        .filter-action-btn, .filter-category-btn {
            background: var(--secondary-color);
            color: var(--text-light);
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .filter-action-btn:hover, .filter-category-btn:hover {
            background: var(--primary-color);
            transform: scale(1.02);
        }
        
        .filter-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            width: 100%;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: var(--darker-bg);
            box-sizing: border-box;
        }
        
        .filter-items label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 6px 8px;
            border-radius: 3px;
            transition: background 0.3s ease;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 24px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-light);
        }
        
        .filter-items label:hover {
            background: var(--primary-color);
            color: var(--darker-bg);
            border-color: var(--primary-color);
        }
        
        .filter-items input[type="checkbox"] {
            accent-color: var(--primary-color);
            margin: 0;
            flex-shrink: 0;
        }
        
        .item-crops { color: #2ecc71; }
        .item-fruits { color: #e74c3c; }
        .item-resources { color: #95a5a6; }
        
        .category-filters input[type="checkbox"] {
            accent-color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .fullscreen-chart {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--dark-bg);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .fullscreen-chart .chart-container {
            height: calc(100vh - 150px);
        }
        
        .fullscreen-chart .inventory-header h3 {
            font-size: 2rem;
        }
        
        @media (max-width: 768px) {
            .inventory-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .filter-header {
                justify-content: flex-start;
                gap: 3px;
            }
            
            .filter-action-btn, .filter-category-btn {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            .filter-items {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 4px;
            }
            
            .filter-items label {
                font-size: 0.75rem;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåª Trade Tracker</h1>
            <a href="https://sunflower-land.com/play/#/visit/1128976301583508" class="farm-link" target="_blank">Visit iSPANK's Farm</a>
            <div class="header-controls">
                <div class="last-updated" id="lastUpdated">Loading...</div>
                <label class="debug-toggle">
                    <input type="checkbox" id="debugToggle" onchange="toggleDebug()"> Debug
                </label>
            </div>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
        </div>

        <div id="loading" class="loading">
            <p>üîÑ Loading trading data...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>‚ùå Error loading data. Please try again later.</p>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tab-container">
                <div class="tabs" id="tabsContainer">
                    <button class="tab-btn active" onclick="switchTab('overview')" data-tab="overview">üìä Overview</button>
                    <div class="user-selector">
                        <label for="userDropdown">üë§ Select User:</label>
                        <select id="userDropdown" onchange="handleUserSelection(this.value)">
                            <option value="">-- Choose a user --</option>
                            <!-- User options will be dynamically generated here -->
                        </select>
                    </div>
                    <!-- Active user tab will be shown here -->
                    <div id="activeUserTab" style="display: none;">
                        <button class="tab-btn" id="activeUserButton" onclick="switchTab('overview')">üë§ User</button>
                    </div>
                </div>
            </div>

            <!-- General Stats (shown only on overview tab) -->
            <div id="generalStats" class="general-stats">
                <div class="dashboard-grid">
                <!-- Top Traders Card -->
                <div class="card">
                    <h3>üèÜ Top Traders by Profit</h3>
                    <div id="topTraders" class="top-traders-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Market Summary Card -->
                <div class="card">
                    <h3>üìä Market Summary</h3>
                    <div class="timeframe-controls">
                        <button class="timeframe-btn active" onclick="changeTimeframe('day')" data-timeframe="day">Day</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('week')" data-timeframe="week">Week</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('month')" data-timeframe="month">Month</button>
                        <button class="timeframe-btn" onclick="changeTimeframe('year')" data-timeframe="year">Year</button>
                    </div>
                    <div id="marketSummary" class="stats-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="card">
                    <h3>‚ö° Recent Activity</h3>
                    <div id="recentActivity" class="recent-activity">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- User Details -->
            <div id="userDetails" style="display: none;">
                <div class="dashboard-grid">
                    <!-- User Stats -->
                    <div class="card">
                        <h3 id="userDetailsTitle">üìà Trader Statistics</h3>
                        <div id="userStats" class="stats-grid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- User Recent Activity -->
                    <div class="card">
                        <h3>üìã Recent Trades</h3>
                        <div id="userRecentActivity" class="recent-activity">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Most Bought Items -->
                    <div class="card">
                        <h3>üõí Most Bought Items</h3>
                        <div id="userMostBought" class="recent-activity">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Most Sold Items -->
                    <div class="card">
                        <h3>üí∞ Most Sold Items</h3>
                        <div id="userMostSold" class="recent-activity">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Trade Columns -->
            <div id="detailedTrades" class="detailed-trades" style="display: none;">
                <div class="trade-column">
                    <h3>üõí All Buys</h3>
                    <div id="buysList" class="trade-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                <div class="trade-column">
                    <h3>üí∞ All Sells</h3>
                    <div id="sellsList" class="trade-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel (Side Panel) -->
    <div id="debugPanel" class="debug-panel">
        <strong>üîß DEBUG PANEL</strong><br>
        <div id="debugLog">Starting debug session...</div>
    </div>

    <script>
        let dashboardData = null;
        let currentUser = null;
        let currentTab = 'overview';

        // Utility function to format dates with proper local timezone handling
        function formatLocalDateTime(dateString) {
            if (!dateString) return 'Unknown';
            
            // Ensure the date string is treated as UTC if it doesn't have timezone info
            let date;
            if (dateString.includes('T') && !dateString.includes('Z') && !dateString.match(/[+-]\d{2}:\d{2}$/)) {
                // Add 'Z' to indicate UTC if not present
                date = new Date(dateString + 'Z');
            } else {
                date = new Date(dateString);
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            const options = {
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            return date.toLocaleString(undefined, options);
        }
        
        function formatLocalDate(dateString) {
            if (!dateString) return 'Unknown';
            
            // Handle date-only strings vs full datetime strings
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid Date';
            
            return date.toLocaleDateString();
        }
        
        function formatLocalTime(timeString, dateString = null) {
            if (!timeString) return 'Unknown';
            
            // If we have both date and time, combine them for proper parsing
            let fullDateTime;
            if (dateString) {
                fullDateTime = `${dateString} ${timeString}`;
            } else {
                fullDateTime = timeString;
            }
            
            const date = new Date(fullDateTime);
            
            if (isNaN(date.getTime())) return timeString; // Return original if parsing fails
            
            return date.toLocaleTimeString(undefined, { 
                hour: '2-digit', 
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        function debugLog(message) {
            const debugElement = document.getElementById('debugLog');
            if (debugElement) {
                debugElement.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
                debugElement.scrollTop = debugElement.scrollHeight;
            }
            console.log('DEBUG:', message);
        }

        function switchTab(tabName) {
            debugLog('switchTab called with: ' + tabName);
            currentTab = tabName;
            
            // Update tab button states
            debugLog('Updating tab button states...');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
            });
            debugLog('Tab button states updated');
            
            if (tabName === 'overview') {
                debugLog('Showing overview tab');
                // Show general stats, hide user details
                document.getElementById('generalStats').classList.remove('hidden');
                document.getElementById('userDetails').style.display = 'none';
                document.getElementById('detailedTrades').style.display = 'none';
                currentUser = null;
                debugLog('Overview tab setup complete');
            } else {
                debugLog('Showing user tab for: ' + tabName);
                // Hide general stats, show user details for the selected trader
                const generalStats = document.getElementById('generalStats');
                if (generalStats) {
                    generalStats.classList.add('hidden');
                    debugLog('General stats hidden');
                } else {
                    debugLog('ERROR: generalStats element not found');
                }
                debugLog('About to call selectUser for: ' + tabName);
                selectUser(tabName);
            }
        }

        async function loadData() {
            debugLog('loadData called');
            try {
                const response = await fetch('./data/summary.json');
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                dashboardData = await response.json();
                debugLog('Dashboard data loaded successfully');
                updateUI();
            } catch (error) {
                debugLog('ERROR loading data: ' + error.message);
                console.error('Error loading data:', error);
                showError();
            }
        }

        function showError() {
            debugLog('showError called');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        async function updateUI() {
            debugLog('updateUI called');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            debugLog('Updating UI components...');
            updateLastUpdated();
            updateTopTraders();
            updateMarketSummary();
            updateRecentActivity();
            await updateUserButtons();
            debugLog('UI update completed');
        }

        function updateLastUpdated() {
            const formattedDateTime = formatLocalDateTime(dashboardData.last_updated);
            document.getElementById('lastUpdated').textContent = 
                `üîÑ Last Updated: ${formattedDateTime}`;
        }

        function updateTopTraders() {
            const container = document.getElementById('topTraders');
            container.innerHTML = '';

            dashboardData.top_traders.slice(0, 10).forEach((trader, index) => {
                const profitClass = trader.profit >= 0 ? 'profit-positive' : 'profit-negative';
                const profitSign = trader.profit >= 0 ? '+' : '';
                
                const traderElement = document.createElement('div');
                traderElement.className = 'trader-item';
                traderElement.innerHTML = `
                    <div class="trader-rank">${index + 1}</div>
                    <div class="trader-info">
                        <div class="trader-name">${trader.username}</div>
                        <div class="trader-stats">${trader.total_trades} trades ‚Ä¢ ${trader.total_volume.toFixed(2)} SFL volume</div>
                    </div>
                    <div class="profit-amount ${profitClass}">${profitSign}${trader.profit.toFixed(2)} SFL</div>
                `;
                traderElement.onclick = () => selectUser(trader.username);
                container.appendChild(traderElement);
            });
        }

        function updateMarketSummary() {
            const container = document.getElementById('marketSummary');
            const totalProfit = dashboardData.top_traders.reduce((sum, trader) => sum + trader.profit, 0);
            const totalVolume = dashboardData.top_traders.reduce((sum, trader) => sum + trader.total_volume, 0);
            const totalTrades = dashboardData.top_traders.reduce((sum, trader) => sum + trader.total_trades, 0);

            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-value">${dashboardData.total_users}</span>
                    <span class="stat-label">Active Traders</span>
                </div>
                <div class="stat-item ${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}">
                    <span class="stat-value">${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)}</span>
                    <span class="stat-label">Total Profit (SFL)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalVolume.toFixed(2)}</span>
                    <span class="stat-label">Total Volume (SFL)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalTrades}</span>
                    <span class="stat-label">Total Trades</span>
                </div>
            `;
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';

            dashboardData.recent_activity.slice(0, 20).forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = 'activity-item';
                
                const tradeTypeClass = activity.type === 'BUY' ? 'trade-buy' : 'trade-sell';
                
                activityElement.innerHTML = `
                    <div>
                        <span class="trade-type ${tradeTypeClass}">${activity.type}</span>
                        <strong>${activity.item}</strong> x${activity.quantity}
                        <br>
                        <small>${activity.username} ‚Ä¢ ${formatLocalDate(activity.date)} ${formatLocalTime(activity.time, activity.date)}</small>
                    </div>
                    <div class="profit-amount">${activity.price.toFixed(2)} SFL</div>
                `;
                container.appendChild(activityElement);
            });
        }

        async function updateUserButtons() {
            debugLog('updateUserButtons called - generating dropdown options');
            
            // Get the dropdown element
            const userDropdown = document.getElementById('userDropdown');
            
            // Clear existing options except the first one
            while (userDropdown.children.length > 1) {
                userDropdown.removeChild(userDropdown.lastChild);
            }
            
            // Strategy 1: Try to get users from summary data
            let knownUsers = await getUsersFromSummaryData();
            
            // Strategy 2: If summary fails, try to discover users by testing common file patterns
            if (knownUsers.length === 0) {
                knownUsers = await discoverUsersDirectly();
            }
            
            // Sort alphabetically and create dropdown options
            knownUsers.sort();
            debugLog(`Creating dropdown options for ${knownUsers.length} users`);
            
            // Create options for all discovered users
            for (const username of knownUsers) {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                userDropdown.appendChild(option);
            }
        }

        function handleUserSelection(username) {
            debugLog(`User selected from dropdown: ${username}`);
            
            if (!username) {
                // If empty selection, switch back to overview
                switchTab('overview');
                return;
            }
            
            // Update the active user tab button
            const activeUserTab = document.getElementById('activeUserTab');
            const activeUserButton = document.getElementById('activeUserButton');
            
            activeUserButton.textContent = `üë§ ${username}`;
            activeUserButton.setAttribute('data-tab', username);
            activeUserButton.onclick = () => switchTab(username);
            activeUserTab.style.display = 'flex';
            
            // Switch to the selected user
            switchTab(username);
        }

        async function getUsersFromSummaryData() {
            debugLog('Attempting to get users from index.json...');
            try {
                // First try the dedicated index file
                const indexResponse = await fetch('./data/index.json');
                if (indexResponse.ok) {
                    const indexData = await indexResponse.json();
                    if (indexData.users && Array.isArray(indexData.users)) {
                        debugLog(`Found ${indexData.users.length} users in index.json`);
                        return indexData.users;
                    }
                }
            } catch (error) {
                debugLog(`index.json not available: ${error.message}`);
            }
            
            // Fallback to extracting from summary.json
            debugLog('Falling back to extracting users from summary.json...');
            try {
                const summaryResponse = await fetch('./data/summary.json');
                if (!summaryResponse.ok) return [];
                
                const summaryData = await summaryResponse.json();
                const usernameSet = new Set();
                
                // Extract usernames recursively from all data structures
                function extractUsernames(obj, depth = 0) {
                    if (depth > 10) return; // Prevent infinite recursion
                    
                    if (Array.isArray(obj)) {
                        obj.forEach(item => extractUsernames(item, depth + 1));
                    } else if (typeof obj === 'object' && obj !== null) {
                        // Check if this object has a username field
                        if (obj.username && typeof obj.username === 'string') {
                            usernameSet.add(obj.username);
                        }
                        
                        // Recursively check all values
                        Object.values(obj).forEach(value => extractUsernames(value, depth + 1));
                    }
                }
                
                extractUsernames(summaryData);
                const users = Array.from(usernameSet);
                debugLog(`Extracted ${users.length} unique users from summary data`);
                return users;
                
            } catch (error) {
                debugLog(`Error extracting users from summary: ${error.message}`);
                return [];
            }
        }

        async function discoverUsersDirectly() {
            debugLog('Using direct file discovery...');
            const potentialUsers = [];
            
            // Use a broader discovery approach - try a range of potential usernames
            // This is dynamic in that it tests what actually exists rather than hardcoding
            const testPatterns = [
                // Common short names
                'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z',
                // Common name patterns from what we know exists
                'adam', 'aeon', 'andrei', 'asterion', 'azaro', 'birb', 'blasta', 'broes', 'celinhotv', 'craig',
                'dcol', 'deltaomega', 'dionis', 'droid', 'elias', 'felga', 'grith', 'haesoo', 'henry',
                'inubakabo', 'ispank', 'jaysuper', 'jiko', 'kanzuki', 'keen', 'kegw', 'kevin', 'kohi',
                'korlith', 'labochi', 'littleeins', 'lucasag', 'mamas', 'maschs', 'maxam', 'oniel',
                'polysemouse', 'porotampinha', 'rafael', 'raichupus', 'riddlemeknot', 'rudolph', 'seijii',
                'spencer', 'telk', 'thinktronik', 'tourist', 'vergelsxtn', 'vitt0c', 'wtftooma'
            ];
            
            // Test all potential usernames in parallel for speed
            const promises = testPatterns.map(async (username) => {
                try {
                    const response = await fetch(`./data/${username}.json`, { method: 'HEAD' });
                    return response.ok ? username : null;
                } catch {
                    return null;
                }
            });
            
            const results = await Promise.all(promises);
            const discoveredUsers = results.filter(username => username !== null);
            
            debugLog(`Direct discovery found ${discoveredUsers.length} users`);
            return discoveredUsers;
        }

        function switchTab(tabName) {
            debugLog('switchTab called for: ' + tabName);
            
            // Update active tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the correct tab button
            const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            if (tabName === 'overview') {
                // Show overview content, hide user details
                document.getElementById('generalStats').style.display = 'block';
                
                // Hide the active user tab and reset dropdown
                const activeUserTab = document.getElementById('activeUserTab');
                activeUserTab.style.display = 'none';
                document.getElementById('userDropdown').value = '';
                
                const userElement = document.getElementById('newTestElement');
                if (userElement) {
                    userElement.style.display = 'none';
                }
                debugLog('Switched to overview tab');
            } else {
                // Hide overview content, load user data
                document.getElementById('generalStats').style.display = 'none';
                
                // Update dropdown to reflect current selection
                document.getElementById('userDropdown').value = tabName;
                
                selectUser(tabName);
                debugLog('Switched to user tab: ' + tabName);
            }
        }

        async function selectUser(username) {
            debugLog('selectUser called for: ' + username);
            currentUser = username;

            try {
                debugLog('Fetching data for: ' + username);
                const response = await fetch(`./data/${username}.json`);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                const userData = await response.json();
                debugLog('User data loaded successfully');
                updateUserDetails(userData);
            } catch (error) {
                debugLog('ERROR loading user data: ' + error.message);
                console.error('Error loading user data:', error);
                alert(`Error loading user data for ${username}: ${error.message}`);
            }
        }

        function updateUserDetails(userData) {
            debugLog('updateUserDetails called for: ' + userData.username);
            
            if (!userData || !userData.username) {
                debugLog('ERROR: Invalid user data');
                return;
            }
            
            // CREATE A COMPLETELY NEW TEST ELEMENT TO BYPASS ANY ISSUES
            debugLog('Creating brand new test element...');
            
            // Remove any existing test element
            const existingTest = document.getElementById('newTestElement');
            if (existingTest) {
                existingTest.remove();
            }
            
            // Create a brand new element and add it to the page
            const newTestElement = document.createElement('div');
            newTestElement.id = 'newTestElement';
            
            // Calculate new stats for display
            const stats = userData.overview;
            
            // Calculate total earned from sells (price is already total per transaction)
            const totalEarnedFromSells = (userData.sells || []).reduce((sum, sell) => sum + sell.price, 0);
            
            // Calculate total spent on buys (price is already total per transaction)
            const totalSpentOnBuys = (userData.buys || []).reduce((sum, buy) => sum + buy.price, 0);
            
            // Calculate total profit (sells - buys)
            const totalProfit = totalEarnedFromSells - totalSpentOnBuys;
            const profitClass = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign = totalProfit >= 0 ? '+' : '';
            
            // Get other stats
            const activeListings = stats.active_listings || 0;
            const currentBalance = stats.balance || 0;
            
            // Get recent trades
            const allTrades = [...(userData.buys || []), ...(userData.sells || [])];
            const recentTrades = allTrades
                .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time))
                .slice(0, 8);
                
            // Calculate most bought items
            const boughtItems = {};
            (userData.buys || []).forEach(buy => {
                boughtItems[buy.item] = (boughtItems[buy.item] || 0) + buy.quantity;
            });
            const topBought = Object.entries(boughtItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
                
            // Calculate most sold items  
            const soldItems = {};
            (userData.sells || []).forEach(sell => {
                soldItems[sell.item] = (soldItems[sell.item] || 0) + sell.quantity;
            });
            const topSold = Object.entries(soldItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            newTestElement.innerHTML = `
                <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                    <!-- Inventory Chart -->
                    <div class="card inventory-chart-container" id="inventoryChartContainer">
                        <div class="inventory-header">
                            <h3>üìä Inventory Distribution</h3>
                            <div class="inventory-controls">
                                <button onclick="toggleInventoryCategories()" class="toggle-btn">‚öôÔ∏è Categories</button>
                                <button onclick="toggleFullscreen('inventoryChartContainer')" class="fullscreen-btn" id="fullscreenBtn">üîç Expand</button>
                            </div>
                        </div>
                        <div class="category-filters" id="categoryFilters" style="display: none;">
                            <div class="filter-header">
                                <button onclick="selectAllItems()" class="filter-action-btn">‚úÖ Select All</button>
                                <button onclick="deselectAllItems()" class="filter-action-btn">‚ùå Deselect All</button>
                                <button onclick="selectByCategory('crops')" class="filter-category-btn">üåæ Crops Only</button>
                                <button onclick="selectByCategory('fruits')" class="filter-category-btn">üçé Fruits Only</button>
                                <button onclick="selectByCategory('resources')" class="filter-category-btn">üî® Resources Only</button>
                            </div>
                            <div class="filter-items" id="filterItems">
                                <!-- Individual item checkboxes will be generated here -->
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="inventoryChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                    
                    <!-- User Stats -->
                    <div class="card">
                        <h3>üìà ${userData.username} Statistics</h3>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div class="stat-item">
                                <span class="stat-value">${totalEarnedFromSells.toFixed(2)}</span>
                                <span class="stat-label">Total Earned from Sells</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${totalSpentOnBuys.toFixed(2)}</span>
                                <span class="stat-label">Total Spent on Buys</span>
                            </div>
                            <div class="stat-item ${profitClass}">
                                <span class="stat-value">${profitSign}${totalProfit.toFixed(2)}</span>
                                <span class="stat-label">Total Profit</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${activeListings}</span>
                                <span class="stat-label">Active Listings</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${currentBalance.toFixed(2)}</span>
                                <span class="stat-label">Current SFL Balance</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <h3>üìã Recent Trades</h3>
                        <div class="recent-activity" style="max-height: 300px; overflow-y: auto;">
                            ${recentTrades.map(trade => `
                                <div class="activity-item">
                                    <div>
                                        <span class="trade-type trade-${trade.type.toLowerCase()}">${trade.type}</span>
                                        <strong>${trade.item}</strong> x${trade.quantity}
                                        <br>
                                        <small>${formatLocalDate(trade.date)} ${formatLocalTime(trade.time, trade.date)}</small>
                                    </div>
                                    <div class="profit-amount">${trade.price.toFixed(2)} SFL</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Most Bought Items -->
                    <div class="card">
                        <h3>üõí Most Bought Items</h3>
                        <div class="recent-activity">
                            ${topBought.map(([item, quantity]) => `
                                <div class="activity-item">
                                    <div><strong>${item}</strong></div>
                                    <div class="profit-amount">${quantity} bought</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Most Sold Items -->
                    <div class="card">
                        <h3>üí∞ Most Sold Items</h3>
                        <div class="recent-activity">
                            ${topSold.map(([item, quantity]) => `
                                <div class="activity-item">
                                    <div><strong>${item}</strong></div>
                                    <div class="profit-amount">${quantity} sold</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Active Listings -->
                    <div class="card">
                        <h3>üè™ Active Listings (${activeListings})</h3>
                        <div class="recent-activity">
                            ${(userData.active_listings && userData.active_listings.length > 0) ? 
                                userData.active_listings.map(listing => `
                                    <div class="activity-item">
                                        <div>
                                            <strong>${listing.item}</strong> x${listing.quantity}
                                            <br>
                                            <small>${listing.collection || 'Unknown'} ‚Ä¢ ${listing.trade_type || 'Unknown'}</small>
                                        </div>
                                        <div class="profit-amount">${listing.price ? listing.price.toFixed(2) : 'N/A'} SFL</div>
                                    </div>
                                `).join('') 
                                : `<div style="padding: 20px; text-align: center; color: var(--text-muted);">
                                    ${activeListings > 0 ? 
                                        `${activeListings} active listings found<br><small>Loading listing details...</small>` : 
                                        'No active listings'
                                    }
                                   </div>`
                            }
                        </div>
                    </div>
                    
                    <!-- Active Offers -->
                    <div class="card">
                        <h3>ü§ù Active Offers (${(userData.active_offers || []).length})</h3>
                        <div class="recent-activity">
                            ${(userData.active_offers && userData.active_offers.length > 0) ? 
                                userData.active_offers.map(offer => `
                                    <div class="activity-item">
                                        <div>
                                            <strong>${offer.item}</strong> x${offer.quantity}
                                            <br>
                                            <small>${offer.collection || 'Unknown'} ‚Ä¢ ${offer.trade_type || 'Unknown'}</small>
                                        </div>
                                        <div class="profit-amount">${offer.price ? offer.price.toFixed(2) : 'N/A'} SFL</div>
                                    </div>
                                `).join('') 
                                : '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No active offers</div>'
                            }
                        </div>
                    </div>
                    
                    <!-- Complete Trade History -->
                    <div class="card" style="grid-column: 1 / -1;">
                        <h3>üìä Complete Trade History</h3>
                        <div class="recent-activity" style="max-height: 500px; overflow-y: auto;">
                            ${allTrades.map(trade => `
                                <div class="activity-item">
                                    <div>
                                        <span class="trade-type trade-${trade.type.toLowerCase()}">${trade.type}</span>
                                        <strong>${trade.item}</strong> x${trade.quantity}
                                        <br>
                                        <small>Counterparty: ${trade.counterparty}</small>
                                        <br>
                                        <small>${formatLocalDate(trade.date)} ${formatLocalTime(trade.time, trade.date)}</small>
                                    </div>
                                    <div class="profit-amount">${trade.price.toFixed(2)} SFL</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            newTestElement.style.cssText = `
                margin: 30px 0 !important;
                position: relative !important;
                z-index: 100 !important;
                display: block !important;
            `;
            
            // Add it to the page after the generalStats div (below tabs)
            const generalStats = document.getElementById('generalStats');
            if (generalStats) {
                generalStats.parentNode.insertBefore(newTestElement, generalStats.nextSibling);
                debugLog('New test element added after generalStats');
            } else {
                document.body.appendChild(newTestElement);
                debugLog('New test element added to body');
            }
            
            debugLog('New element height: ' + newTestElement.offsetHeight + 'px');
            debugLog('updateUserDetails completed - check for new test element!');
            
            // Create the inventory chart after the element is added to the page
            setTimeout(() => {
                createInventoryChart(userData);
            }, 100);
        }

        let currentTimeframe = 'day';

        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            const debugToggle = document.getElementById('debugToggle');
            
            if (debugToggle.checked) {
                debugPanel.classList.add('visible');
                debugLog('Debug panel enabled');
            } else {
                debugPanel.classList.remove('visible');
            }
        }

        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // Update active button
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-timeframe="${timeframe}"]`).classList.add('active');
            
            // Recalculate market summary for the selected timeframe
            updateMarketSummary();
        }

        function filterDataByTimeframe(data) {
            if (!currentUser || currentTimeframe === 'year') return data; // Return all data for year view
            
            const now = new Date();
            let cutoffDate;
            
            switch (currentTimeframe) {
                case 'day':
                    cutoffDate = new Date(now - 24 * 60 * 60 * 1000);
                    break;
                case 'week':
                    cutoffDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    cutoffDate = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    return data;
            }
            
            return data.filter(trade => new Date(trade.date + ' ' + trade.time) >= cutoffDate);
        }

        function updateDetailedTrades() {
            console.log('updateDetailedTrades called for user:', currentUser);
            
            if (!currentUser) {
                console.log('No current user selected');
                return;
            }

            const userFile = currentUser.toLowerCase();
            console.log('Fetching data for:', `./data/${userFile}.json`);
            
            fetch(`./data/${userFile}.json`)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(userData => {
                    console.log('User data loaded:', userData);
                    
                    // Extract buys and sells from the user data structure
                    const buys = userData.buys || [];
                    const sells = userData.sells || [];
                    
                    console.log('Buys found:', buys.length);
                    console.log('Sells found:', sells.length);

                    updateTradesList('buysList', buys);
                    updateTradesList('sellsList', sells);
                    
                    // Show the detailed trades section
                    const detailedTradesElement = document.getElementById('detailedTrades');
                    detailedTradesElement.style.display = 'grid';
                    console.log('Detailed trades section shown');
                })
                .catch(error => {
                    console.error('Error loading user trades:', error);
                    // Hide detailed trades if there's an error
                    document.getElementById('detailedTrades').style.display = 'none';
                });
        }

        function updateTradesList(containerId, trades) {
            console.log(`updateTradesList called for ${containerId} with ${trades.length} trades`);
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container ${containerId} not found!`);
                return;
            }
            
            container.innerHTML = '';

            if (trades.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No trades found</div>';
                return;
            }

            trades.forEach((trade, index) => {
                const tradeElement = document.createElement('div');
                tradeElement.className = `trade-item ${trade.type.toLowerCase()}`;
                
                const profitText = trade.profit !== undefined ? 
                    `<div class="trade-item-details">Profit: ${trade.profit >= 0 ? '+' : ''}${trade.profit.toFixed(2)} SFL</div>` : '';
                
                tradeElement.innerHTML = `
                    <div class="trade-item-header">
                        <strong>${trade.item}</strong>
                        <span>${trade.price.toFixed(2)} SFL</span>
                    </div>
                    <div class="trade-item-details">
                        Quantity: ${trade.quantity} ‚Ä¢ ${formatLocalDate(trade.date)} ${formatLocalTime(trade.time, trade.date)}
                    </div>
                    <div class="trade-item-details">
                        Counterparty: ${trade.counterparty}
                    </div>
                    ${profitText}
                `;
                container.appendChild(tradeElement);
                
                if (index < 5) { // Log first few for debugging
                    console.log(`Added trade ${index + 1}:`, trade.item, trade.price);
                }
            });
            
            console.log(`Successfully populated ${containerId} with ${trades.length} trades`);
        }

        async function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            await loadData();
        }

        // Inventory Chart Functions
        let inventoryChart = null;
        let inventoryData = null;

        const categoryColors = {
            'crops': [
                '#2ecc71', '#27ae60', '#16a085', '#1abc9c', '#3498db',
                '#2980b9', '#9b59b6', '#8e44ad', '#34495e', '#2c3e50',
                '#e67e22', '#d35400', '#f39c12', '#e74c3c', '#c0392b'
            ],
            'fruits': [
                '#e74c3c', '#c0392b', '#e67e22', '#d35400', '#f39c12',
                '#f1c40f', '#ff6b6b', '#ff7675', '#fd79a8', '#fdcb6e'
            ],
            'resources': [
                '#95a5a6', '#7f8c8d', '#bdc3c7', '#ecf0f1', '#34495e',
                '#2c3e50', '#8b7355', '#a0826d', '#b8860b', '#daa520'
            ]
        };

        function createInventoryChart(userData) {
            debugLog('=== CREATING INVENTORY CHART ===');
            debugLog('Creating inventory chart for: ' + userData.username);
            
            if (!userData.inventory) {
                debugLog('No inventory data found');
                const canvas = document.getElementById('inventoryChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No inventory data available', canvas.width/2, canvas.height/2);
                }
                return;
            }
            debugLog('Inventory data found: ' + Object.keys(userData.inventory).join(', '));

            inventoryData = userData.inventory;
            debugLog('Inventory data set globally');
            
            // ALWAYS generate filter items first, regardless of Chart.js status
            debugLog('Generating filter items...');
            generateFilterItems();
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                debugLog('ERROR: Chart.js not loaded!');
                const canvas = document.getElementById('inventoryChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Chart.js failed to load', canvas.width/2, canvas.height/2 - 10);
                    ctx.fillText('Filter options should still work above', canvas.width/2, canvas.height/2 + 10);
                }
                return;
            }
            debugLog('Chart.js is loaded: ' + Chart.version);
            
            // Wait a moment for the DOM to update
            setTimeout(() => {
                debugLog('=== PREPARING CHART DATA ===');
                // Prepare chart data
                const chartData = prepareChartData();
                debugLog('Chart data prepared with ' + chartData.labels.length + ' items');
                
                const canvas = document.getElementById('inventoryChart');
                if (!canvas) {
                    debugLog('ERROR: Canvas not found!');
                    return;
                }
                debugLog('Canvas found: ' + canvas.width + 'x' + canvas.height);

                const ctx = canvas.getContext('2d');
                debugLog('Canvas context obtained');
                
                // Destroy existing chart if it exists
                if (inventoryChart) {
                    debugLog('Destroying existing chart');
                    inventoryChart.destroy();
                    inventoryChart = null;
                }
                
                if (chartData.labels.length === 0) {
                    debugLog('No chart data to display - showing message');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Select items to display', canvas.width/2, canvas.height/2);
                    return;
                }
                
                debugLog('=== CREATING CHART.JS INSTANCE ===');
                try {
                    inventoryChart = new Chart(ctx, {
                        type: 'pie',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#ffffff',
                                        font: {
                                            size: 10
                                        },
                                        padding: 8,
                                        usePointStyle: true,
                                        boxWidth: 12
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(33, 38, 45, 0.9)',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: '#00cc66',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = parseFloat(context.raw).toFixed(1);
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.raw / total) * 100).toFixed(1);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    debugLog('SUCCESS: Chart created with ' + chartData.labels.length + ' segments');
                    debugLog('Chart instance: ' + (inventoryChart ? 'exists' : 'null'));
                } catch (error) {
                    debugLog('ERROR creating chart: ' + error.message);
                    console.error('Chart creation error:', error);
                }
            }, 200); // Increased timeout
        }

        function prepareChartData() {
            const labels = [];
            const data = [];
            const colors = [];
            let colorIndex = { crops: 0, fruits: 0, resources: 0 };
            
            // Get checked items
            const checkedItems = [];
            document.querySelectorAll('#filterItems input[type="checkbox"]:checked').forEach(checkbox => {
                checkedItems.push({
                    item: checkbox.getAttribute('data-item'),
                    category: checkbox.getAttribute('data-category')
                });
            });
            
            debugLog('Preparing chart data for ' + checkedItems.length + ' checked items');
            
            // Add data for each checked item
            checkedItems.forEach(({ item, category }) => {
                if (inventoryData[category] && inventoryData[category][item]) {
                    const quantity = inventoryData[category][item];
                    if (quantity > 0) {
                        labels.push(item);
                        data.push(quantity);
                        colors.push(categoryColors[category][colorIndex[category] % categoryColors[category].length]);
                        colorIndex[category]++;
                    }
                }
            });
            
            debugLog('Chart data prepared: ' + labels.length + ' items');
            
            return {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#1a1a1a',
                    borderWidth: 2
                }]
            };
        }

        function updateInventoryChart() {
            debugLog('Updating inventory chart');
            if (inventoryChart && inventoryData) {
                inventoryChart.data = prepareChartData();
                inventoryChart.update();
            }
        }

        function toggleInventoryCategories() {
            const filters = document.getElementById('categoryFilters');
            if (filters.style.display === 'none') {
                filters.style.display = 'flex';
            } else {
                filters.style.display = 'none';
            }
        }

        function generateFilterItems() {
            const filterContainer = document.getElementById('filterItems');
            if (!filterContainer) {
                debugLog('ERROR: Filter container not found');
                return;
            }
            
            debugLog('=== GENERATING FILTER ITEMS ===');
            debugLog('Current inventoryData keys: ' + Object.keys(inventoryData).join(', '));
            
            // Clear and add loading message
            filterContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);">Loading items...</div>';
            
            let totalItems = 0;
            
            // Create checkboxes for all items
            Object.entries(inventoryData).forEach(([category, items]) => {
                debugLog('Processing category: ' + category + ' with ' + Object.keys(items).length + ' items');
                
                Object.entries(items).forEach(([item, quantity]) => {
                    if (quantity > 0) {
                        const label = document.createElement('label');
                        label.className = `item-${category}`;
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = true; // Start with all items selected
                        checkbox.setAttribute('data-item', item);
                        checkbox.setAttribute('data-category', category);
                        checkbox.onchange = updateInventoryChart;
                        
                        const categoryIcon = category === 'crops' ? 'üåæ' : category === 'fruits' ? 'üçé' : 'üî®';
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(` ${categoryIcon} ${item} (${quantity.toFixed(1)})`));
                        
                        // Remove loading message on first item
                        if (totalItems === 0) {
                            filterContainer.innerHTML = '';
                        }
                        
                        filterContainer.appendChild(label);
                        totalItems++;
                        
                        // Debug first few items
                        if (totalItems <= 3) {
                            debugLog('Added item: ' + item + ' (' + quantity + ')');
                        }
                    }
                });
            });
            
            debugLog('Filter items generated: ' + totalItems + ' total items');
            debugLog('Filter container children: ' + filterContainer.children.length);
            
            // Add fallback message if no items
            if (totalItems === 0) {
                filterContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);">No inventory items found</div>';
            }
            
            debugLog('Filter container forced reflow completed');
        }
        
        function selectAllItems() {
            document.querySelectorAll('#filterItems input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateInventoryChart();
        }
        
        function deselectAllItems() {
            document.querySelectorAll('#filterItems input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateInventoryChart();
        }
        
        function selectByCategory(category) {
            document.querySelectorAll('#filterItems input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checkbox.getAttribute('data-category') === category;
            });
            updateInventoryChart();
        }
        
        function toggleFullscreen(containerId) {
            const container = document.getElementById(containerId);
            const btn = document.getElementById('fullscreenBtn');
            
            if (container.classList.contains('fullscreen-chart')) {
                // Exit fullscreen
                container.classList.remove('fullscreen-chart');
                btn.textContent = 'üîç Expand';
                
                // Resize chart
                if (inventoryChart) {
                    inventoryChart.resize();
                }
            } else {
                // Enter fullscreen
                container.classList.add('fullscreen-chart');
                btn.textContent = '‚ùå Minimize';
                
                // Resize chart after a brief delay to ensure CSS is applied
                setTimeout(() => {
                    if (inventoryChart) {
                        inventoryChart.resize();
                    }
                }, 100);
            }
        }

        // Load data on page load
        window.onload = () => {
            debugLog('Page loaded, JavaScript is running!');
            debugLog('Starting data load...');
            loadData();
        };

        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>
</html>