name: Trading Monitor

on:
  workflow_dispatch: # Allow manual trigger
  repository_dispatch:
    types: [trigger-trading-update]
  
permissions:
  contents: write  # Allow writing to repository
  pages: write     # Allow GitHub Pages deployment
  id-token: write  # Allow OIDC token

jobs:
  update-trading-data:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Run trading data collection
      env:
        API_KEY: ${{ secrets.SFL_API_KEY }}
        BEARER_TOKEN: ${{ secrets.SFL_BEARER_TOKEN }}
      run: |
        python master.py
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Trading Monitor Bot"
        git add -A
        git diff --staged --quiet || git commit -m "Update trading data - $(date '+%Y-%m-%d %H:%M:%S')"
        
        # Handle potential conflicts by using merge strategy favoring newer data
        git fetch origin main
        git merge origin/main --strategy-option=ours --no-edit || {
          echo "Merge failed, attempting to resolve conflicts automatically..."
          git status --porcelain | grep "^UU" | cut -c4- | xargs -r git add
          git status --porcelain | grep "^AA" | cut -c4- | xargs -r git add
          git status --porcelain | grep "^DD" | cut -c4- | xargs -r git rm
          git commit --no-edit -m "Auto-resolve merge conflicts - $(date '+%Y-%m-%d %H:%M:%S')"
        }
        
        git push origin main
        
    - name: Generate dashboard data
      run: |
        python scripts/generate_dashboard_data.py
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./web
        destination_dir: .
        
    - name: Schedule next workflow run
      run: |
        echo "Workflow completed. Waiting 15 minutes before triggering next run..."
        sleep 900  # Wait 15 minutes
        echo "15 minutes elapsed. Triggering next run..."
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{"event_type":"trigger-trading-update"}'